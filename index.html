<!DOCTYPE html>










<head>
  
</head>


<html>
<style>
	
	

.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
}
	

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}   
  
input[type=text], input[type=password] {
    width: 200px;
    padding: 12px 20px;
    margin: 8px 0;
    display: inline-block;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

button {
    background-color: #f68a1f;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 4px;
    cursor: pointer;
	  border-radius: 4px;
	  -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
	  font-family: "Myriad pro","Trebuchet MS","Lucida Grande","Lucida Sans Unicode","Lucida Sans",sans-serif;
}
button:hover {
    background-color: #da7009;
    color: white;	
}
	


.cancelbtn {
    width: auto;
    padding: 10px 18px;
    background-color: #f44336;
}

.imgcontainer {
    text-align: center;
    margin: 24px 0 12px 0;
}

img.avatar {
    width: 40%;
    border-radius: 50%;
}
	
.label {
    color: black;
    width: 120px;
    height: 50px;
    padding: 6px;
    display: block;
    float:left;
    vertical-align: middle;
}
	
.loginelement {
    width: 130px;
    height: 50px;
    vertical-align: middle;
    line-height: 50px;
    float: left;
}

.container {
    padding: 16px;
}

span.psw {
    float: right;
    padding-top: 16px;
}

/* Change styles for span and cancel button on extra small screens */
@media screen and (max-width: 300px) {
    span.psw {
       display: block;
       float: none;
    }
    .cancelbtn {
       width: 100%;
    }
}
</style>
<body>
  
  <div id="myloader" style="display:none;">
    	<h2>Loading your page...</h2>
    	<div class="loader"></div>
  </div>
    




  <div id="mylogin" style="display:none;">
    
    <h2>Report Login</h2>
        <div class="loginelement"><b>Account Number</b></div>
	<input id="accnumb" type="text" placeholder="Enter Account Number">
	</br>
	
	<div class="loginelement"><b>Username</b></div>
        <input id="uname" type="text" placeholder="Enter Username">
	</br>
        
	<div class="loginelement"><b>Password</b></div>
        <input id="pwd" type="password" placeholder="Enter Password">
	</br>
        
    <button id="submitLogin" >Login</button>
    
    </br></br></br></br>

  <div id="sendStat"></div>

</div>


<div id="myreports" style="display:none;">
	
    <button type="button" id ="logout" class="logout">Log Out</button>
    </br></br>
   

    <h2>Some statistics about your last:</h2>
    <select id="statisticOptions" class="statisticOptions">
        <option>10 Mins</option>
        <option>20 Mins</option>
        <option>30 Mins</option>
	<option>1 Hour</option>
    </select>

    <div id="loadingStats">
	    </br></br>
	    <label><b>...loading your stats...</b></label></br></br>
	    <div class="loader"></div>
	    </br></br>
    </div>

    <div id="loadedStats" style="display:none;">
	    </br></br>
	    <label id="ricevedMessages"><b>Start date</b></label></br>
	    <label id="sentMessages"><b>Start date</b></label></br>
	    <label id="responseFirst"><b>Start date</b></label></br>
	    <label id="responseGeneral"><b>Start date</b></label></br>
            </br></br></br></br></br></br>

    </div>



  
    <h2>Download your transcripts:</h2>
    <label><b>Start date</b></label></br>

    <input id="startdate" type="date" />
    <input id="starthour" type="time">
    </br>

    <label><b>End date</b></label></br>

    <input id="enddate" type="date" />
    <input id="endhour" type="time">
    
    </br></br>
    <label><b>Options: </b></label>
    <select id="transcriptOptions">
        <option>Open</option>
        <option>Close</option>
        <option>Active</option>
    </select>
    </br></br>
    <button type="button" id ="downloadTranscripts" class="downloadTranscripts">Download</button></br></br>
    <div id="reportMSG"></div>
    <a id="hiddenbutton" style="visibility:hidden;" href="">Hidden</a>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script>
  
  var uri = "";
  var uname;
  var pwd;
  var csrf;
  var accnumb = localStorage.getItem('account_number');
  var bearer = localStorage.getItem('bearer');
  var statisticOptions = 0;
  
  function checklogin(accnumb, bearer){	
	$('#myloader').css('display', 'inline');
  	if(!((accnumb === null) || (accnumb === '') || (bearer === null) || (bearer === ''))){
    		$.ajax({
                    url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/msgHist/baseURI.lpCsds?version=1.0",
                    jsonp: "cb",
                    jsonpCallback: "domainCallback",
                    cache: true,
                    dataType: "jsonp",
                    success: function success(data) {
                        if('lpCallError' in data.ResultSet){
				localStorage.setItem('account_number', '');
			   	location.reload(); 
                        }
                        else{
                           	uri = data.ResultSet.lpData[0].lpServer;
                           	console.log(uri);

                           	$.ajax({
                              		url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=0&limit=50",
                              		method: "POST",
                              		jsonp: "cb",
                              		jsonpCallback: "domainCallback",
                              		cache: true,
                              		contentType: "application/json",
                              		data: '{\"start":{\"from\":' + (new Date().getTime()-5000) + ',\"to\":'+ new Date().getTime() + '}}',
                              		success: function success(data) {
						refreshTranscripts();
						$('#myloader').css('display', 'none');
          					$('#myreports').css('display', 'inline');
						loadstats();
                              		},
                              		error: function error(e, text) {
						localStorage.setItem('account_number', '');
				    		location.reload(); 
                              		},
                              		beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); } 
                          	});   
                        }
                    },
                    error: function error(e, text) {
			    console.log(text);
			    localStorage.setItem('account_number', '');
			    location.reload(); 
                    }
              	});
  	  }
	  else{
		  $('#myloader').css('display', 'none');
		  $('#mylogin').css('display', 'inline');
	  }
  }
	
	
checklogin(accnumb, bearer);
  
	
	
  $(document).on('click', function(evt) {
	  if($(evt.target).is('#logout')) {
		  $('#myreports').css('display', 'none');
		  $('#myloader').css('display', 'inline');
		  setTimeout(function(){
			  localStorage.setItem('account_number', '');
			  location.reload();
		  }, 2000);
	  }
  });
		  	
	
  $(document).on('change','#statisticOptions',function(){
	  $('#loadedStats').css('display', 'none');
	  $('#loadingStats').css('display', 'inline');
	  loadstats();
  });

  
  $(document).on('click', function(evt) {
	  if($("#accnumb").val() != ""){
		  if($(evt.target).is('#submitLogin')) {
			  uname = $("#uname").val();
			  pwd = $("#pwd").val();
			  accnumb = $("#accnumb").val();
			  console.log(accnumb + " *** " + uname + " *** " + pwd);
			  $.ajax({
				  url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/agentVep/baseURI.lpCsds?version=1.0",
				  jsonp: "cb",
				  jsonpCallback: "domainCallback",
				  cache: true,
				  dataType: "jsonp",
				  success: function success(data) {
					  if('lpCallError' in data.ResultSet){
						  document.getElementById("sendStat").innerHTML = "Please insert a correct login!";
						  document.getElementById("sendStat").style = "color : red";
					  }
					  else{
						  uri = data.ResultSet.lpData[0].lpServer;
						  console.log(uri);
						  $.ajax({
							  url: "https://" + uri + "/api/account/" + accnumb + "/login?v=1.3",
							  method: "POST",
							  jsonp: "cb",
							  jsonpCallback: "domainCallback",
							  cache: true,
							  contentType: "application/json",
							  data: '{"username":"' + uname + '","password":"' + pwd +'"}',
							  success: function success(data) {
								  console.log("******" + JSON.stringify(data) + "******");
								  csrf = data.csrf;
								  bearer = data.bearer;
								  localStorage.setItem('account_number', accnumb);
								  localStorage.setItem('csrf', csrf);
								  localStorage.setItem('bearer', bearer);
								  $('#mylogin').css('display', 'none');
								  $('#myloader').css('display', 'inline');
								  setTimeout(function(){
									  $('#myloader').css('display', 'none');
									  $('#myreports').css('display', 'inline');
									  refreshTranscripts();
								  }, 2000);
							  },
							  error: function error(e, text) {
								  document.getElementById("sendStat").innerHTML = "Please insert a correct login!";
								  document.getElementById("sendStat").style = "color : red";
							  }
						  });
						  return data;
					  }
				  },
				  error: function error(e, text) {
					  console.log(text);
					  return e;
				  }
			  });
		  }
	  }
  });
    

  function refreshTranscripts(){
	  
	 var date = new Date();
	 var dd = date.getDate();
	 if (dd < 10){
		 dd = "0" + dd;
	 }
    	 var mm = date.getMonth() + 1;
	 if (mm < 10){
		 mm = "0" + mm;
	 }
    	 var y = date.getFullYear();
	 var enddate = y + "-" + mm + "-" + dd;
	 
	 date.setDate(date.getDate() - 7);
	 var dd = date.getDate();
	 if (dd < 10){
		 dd = "0" + dd;
	 }
    	 var mm = date.getMonth() + 1;
	 if (mm < 10){
		 mm = "0" + mm;
	 }
    	 var y = date.getFullYear();
	 var startdate = y + "-" + mm + "-" + dd;

	 
	 $('#startdate').val(startdate);
	 $('#starthour').val("00:00");
	 $('#enddate').val(enddate);
	 $('#endhour').val("00:00");
	  
	  
	 $(document).on('click', function(evt) {
		 
              if($(evt.target).is('.downloadTranscripts')) {
		     
		    startdate = $('#startdate').val();
		    startdate = new Date(startdate);
		    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		    var year = startdate.getFullYear();
  		    var month = months[startdate.getMonth()];
  	            var date = startdate.getDate(); 
		    var hour = $('#starthour').val();
		    startdate = month + " " + date + " " + year + " " + hour + ":00 GMT+0100 (CET)"
		    var d = new Date(startdate);
		    var start = d.getTime();
		      
		    
		    enddate = $('#enddate').val();
		    enddate = new Date(enddate);
		    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		    var year = enddate.getFullYear();
  		    var month = months[enddate.getMonth()];
  	            var date = enddate.getDate(); 
		    var hour = $('#endhour').val();
		    enddate = month + " " + date + " " + year + " " + hour + ":00 GMT+0100 (CET)"
		    var d = new Date(enddate);
		    var end = d.getTime();  

		    var options = $('#transcriptOptions').val();
		      
		    if (start >= end) { 
			    document.getElementById("reportMSG").innerHTML = "Please insert a correct end date!";
                            document.getElementById("reportMSG").style = "color : red"; 
		    }
		    else if (((end - start)/1000) > (60*60*24*31)){
			    document.getElementById("reportMSG").innerHTML = "No more than 30 days!";
                            document.getElementById("reportMSG").style = "color : red"; 
		    }
		    else{
			    document.getElementById("reportMSG").innerHTML = "";
			    downloadTranscripts(start, end, options);
		    }
		      
		      
		    
              }
	 });

	  
	  
  }
	
 function loadstats(){
	 switch($("#statisticOptions").val()) {
    		case "10 Mins":
        		statisticOptions = 10;
        		break;
    		case "20 Mins":
        		statisticOptions = 20;
        		break;
    		case "30 Mins":
        		statisticOptions = 30;
        		break;
		case "1 Hour":
        		statisticOptions = 60;
        		break;
	}

	 var start = Date.now() - (1000*60*statisticOptions);
	 var end = Date.now();
	 console.log(start + "***" + end + "***" + $("#statisticOptions").val());
	 countMessages(start,end);
	 // averageFirts();
	 // averageGeneral();

 }
    
 
 function countMessages(start,end){
	 
	 var receivedMessages = 0;
	 var sentMessages = 0;
	 var isfirstOfMultiple = 1;
	 var firstResponses = 0;
	 var secondResponses = 0;
	 var totTimeFirstResponse = 0;
	 var totTimeGeneralResponse = 0;
	 var conversationsPartial = 0;
	 var timeWaiting = 0;
	 var partialTime = 0;
	 var isFirstMessage;
	 var offset = 0;
	 var begin = end - (1000*60*60*24*30);  // loading Convs started till 1 month ago
	 var body = '{"start":{"from":' + begin + ',"to":' + end + '}, "status": ["OPEN"]}';
	 var answer = [];
	 
	 function loadClosedConvs(offset, callback) {
	 
	 	$.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100&sort=start:desc",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      if(((data.conversationHistoryRecords.length) == 100)&&((data.conversationHistoryRecords[99].info.endTimeL) < start)){
					      offset = offset + 100;
					      answer = answer.concat(data.conversationHistoryRecords);
					      // console.log(data);
					      // console.log(answer);
					      console.log ("adding conversations...");
					      loadClosedConvs(offset, callback);
				      }
				      else{
					      answer = answer.concat(data.conversationHistoryRecords);
					      // console.log("1 monyh ago: " + begin);
					      // console.log(answer.length);
					      for (var i = 0; i < (answer.length); i++){
						      timeWaiting = 0;
						      isFirstMessage = 0;
						      isfirstOfMultiple = 1;
						      var length = answer[i].messageRecords.length;
						      for (var m = 0; m < length; m++){
							      var time = answer[i].messageRecords[m].timeL;
							      if(start <= time && time <= end){
								    if (answer[i].messageRecords[m].sentBy === "Consumer"){
									    if(!m){
										   isFirstMessage = 1; 
									    }
									    if(!timeWaiting){
										  timeWaiting = answer[i].messageRecords[m].timeL;
									    }
									    receivedMessages = receivedMessages + 1;
								    }
								    else{
									    sentMessages = sentMessages + 1;
									    if (isFirstMessage){
										    partialTime = (answer[i].messageRecords[m].timeL - timeWaiting)/1000;
										    totTimeFirstResponse = totTimeFirstResponse + partialTime;
										    firstResponses = firstResponses + 1;
										    isFirstMessage = 0;
										    isfirstOfMultiple = 0;
									    }
									    else{
										    if(isfirstOfMultiple){
											    isfirstOfMultiple = 0;
											    partialTime = (answer[i].messageRecords[m].timeL - timeWaiting)/1000;
											    totTimeGeneralResponse = totTimeGeneralResponse + partialTime;
											    secondResponses = secondResponses + 1;
										    }
									    }
									    
								    }
							      }
							      
						      }

					      }
					      console.log("received messages:" + receivedMessages +" *** sent messages:" + sentMessages);
					      $("#ricevedMessages").empty();
					      $("#ricevedMessages").append("received messages: " + receivedMessages);
					      $("#sentMessages").empty();
					      $("#sentMessages").append("sent messages: " + sentMessages);
					      $("#responseFirst").empty();
					      $("#responseFirst").append("average firts time answer: " + totTimeFirstResponse/firstResponses + " seconds");
					      $("#responseGeneral").empty();
					      $("#responseGeneral").append("average general time answer: " + (totTimeGeneralResponse+totTimeFirstResponse)/(firstResponses+secondResponses) + " seconds");
					      
					      $('#loadingStats').css('display', 'none');
					      $('#loadedStats').css('display', 'inline');

				      }
				      
     
				      
                              },
                              error: function error(e, text) {

                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	 }
	 
	 function loadOpenConvs(offset, callback) {
	 
	 	$.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      if((data.conversationHistoryRecords.length) == 100){
					      offset = offset + 100;
					      answer = answer.concat(data.conversationHistoryRecords);
					      console.log(data.conversationHistoryRecords);
					      console.log(answer);
					      console.log ("adding conversations...");
					      loadOpenConvs(offset, callback);   

				      }
				      else{
					      answer = answer.concat(data.conversationHistoryRecords);
					      body = '{"start":{"from":' + begin + ',"to":' + end + '}, "status": ["CLOSE"]}';
					      offset = 0;
					      loadClosedConvs(offset, callback);
				      }
				      
     
				      
                              },
                              error: function error(e, text) {

                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	 }
	 

	 
	
	 loadOpenConvs(offset, function(err, resp) {
		 // Your code here...
	 });
	 
 }
 
 
 function downloadTranscripts(start, end, options){
	 
	 var conversationsToDownload = 0;
	 var conversationsPartial = 0;
	 var offset = 0;
	 var body = "";
	 var answer = [];
	 var exportObject = [];
	 
	 if (options === "Open"){ 
		 body = '{"start":{"from":' + start + ',"to":' + end + '},"status":["OPEN"]}'; 
	 }
	 else if (options === "Close"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '},"status":["CLOSE"]}';	 
	 }
	 else if (options === "Active"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '}, "messageContentTypes": ["TEXT_PLAIN","RICH_CONTENT"]}';	 
	 }
	 
	 function tryUntilSuccess(offset, callback) {
	 
	 	$.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=" + offset + "&limit=100",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {
				      if(offset == 0){
					      conversationsToDownload = data._metadata.count;
					      conversationsPartial = data.conversationHistoryRecords.length;
					      console.log(conversationsPartial + " of --> " + conversationsToDownload);      
				      }
				      if((data.conversationHistoryRecords.length) == 100){
					      offset = offset + 100;
					      answer = answer.concat(data.conversationHistoryRecords);
					      console.log(data.conversationHistoryRecords);
					      console.log(answer);
					      console.log ("adding conversations...");
					      // setTimeout(function(){
						      tryUntilSuccess(offset, callback);
					      // }, 1000);

				      }
				      else{
					      answer = answer.concat(data.conversationHistoryRecords);
					      console.log(answer);
					      console.log(answer.length);
					      document.getElementById("reportMSG").innerHTML = "Success!";
					      document.getElementById("reportMSG").style = "color : green";
					      for (var i = 0; i < (answer.length); i++){
						      var messages = "";
						      var thismessage = "";
						      var thisactor = "";
						      var length = answer[i].messageRecords.length;
						      for (var m = 0; m < length; m++){
							      var type = answer[i].messageRecords[m].type;
							      if(type === "TEXT_PLAIN"){
								   thismessage = answer[i].messageRecords[m].messageData.msg.text;   
							      }
							      else{
								   thismessage = "-structured content-";
							      }
							      thisactor = answer[i].messageRecords[m].sentBy;
							      messages = messages + "     " + thisactor + ": " + thismessage;
						      }
						      var pieceToAdd = {"start": answer[i].info.startTime,"end": answer[i].info.endTime,"agent": answer[i].info.latestAgentNickname,"conversation": answer[i].info.conversationId,"transcript": messages};
						      console.log(messages);
						      exportObject = exportObject.concat(pieceToAdd);
					      }
				      	      console.log(exportObject);
					      exportData(exportObject);
					      	
					      // console.log(answer[109].agentParticipants["0"]);
					      // console.log(answer[9].agentParticipants["0"]);
				      }
				      
     
				      
                              },
                              error: function error(e, text) {
				      document.getElementById("reportMSG").innerHTML = "System error. Please try again!";
				      document.getElementById("reportMSG").style = "color : red";  
                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); }
		});
	 }
	 
	 tryUntilSuccess(offset, function(err, resp) {
		 // Your code here...
	 });
	 
	 
	 function exportData(exportObject){
		 testTypes = {
    			"start": "String",
    			"end": "String",
    			"agent": "String",
    			"conversation": "String",
    			"transcript": "String"
		 };
		 
		 emitXmlHeader = function () {
    			var headerRow =  '<ss:Row>\n';
    			for (var colName in testTypes) {
        			headerRow += '  <ss:Cell>\n';
        			headerRow += '    <ss:Data ss:Type="String">';
        			headerRow += colName + '</ss:Data>\n';
        			headerRow += '  </ss:Cell>\n';        
    			}
    			headerRow += '</ss:Row>\n';    
    			return '<?xml version="1.0"?>\n' +
           			'<ss:Workbook xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n' +
           			'<ss:Worksheet ss:Name="Sheet1">\n' +
           			'<ss:Table>\n\n' + headerRow;
		};
		 
		 emitXmlFooter = function() {
    			return '\n</ss:Table>\n' +
           			'</ss:Worksheet>\n' +
           			'</ss:Workbook>\n';
		};
		 
		 jsonToSsXml = function (jsonObject) {
    			var row;
    			var col;
    			var xml;
    			var data = typeof jsonObject != "object" ? JSON.parse(jsonObject) : jsonObject;
    
    			xml = emitXmlHeader();

    			for (row = 0; row < data.length; row++) {
        			xml += '<ss:Row>\n';
      
        			for (col in data[row]) {
            				xml += '  <ss:Cell>\n';
            				xml += '    <ss:Data ss:Type="' + testTypes[col]  + '">';
            				xml += data[row][col] + '</ss:Data>\n';
            				xml += '  </ss:Cell>\n';
        			}

        			xml += '</ss:Row>\n';
    			}
    
    			xml += emitXmlFooter();
    			return xml;  
		};
		 
		 download = function (content, filename, contentType) {
    			if (!contentType) contentType = 'application/octet-stream';
    			var a = document.getElementById('hiddenbutton');
    			var blob = new Blob([content], {
        			'type': contentType
    			});
    			a.href = window.URL.createObjectURL(blob);
    			a.download = filename;
		};

		download(jsonToSsXml(exportObject), 'transcripts.xls', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
		$("#hiddenbutton")[0].click();
		 
		 
	 }
	 

	 console.log(start + "****" + end + "****" + options);
	 
 }
   
    
</script>
    
    


</body>
</html>
