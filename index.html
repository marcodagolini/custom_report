<!DOCTYPE html>









<head>
  
</head>


<html>
<style>

.loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
}

/* Safari */
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}   
   

input[type=text], input[type=password] {
    width: 200px;
    padding: 12px 20px;
    margin: 8px 0;
    display: inline-block;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

button {
    background-color: #f68a1f;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 4px;
    cursor: pointer;
	  border-radius: 4px;
	  -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
	  font-family: "Myriad pro","Trebuchet MS","Lucida Grande","Lucida Sans Unicode","Lucida Sans",sans-serif;
}
button:hover {
    background-color: #da7009;
    color: white;	
}

.cancelbtn {
    width: auto;
    padding: 10px 18px;
    background-color: #f44336;
}

.imgcontainer {
    text-align: center;
    margin: 24px 0 12px 0;
}

img.avatar {
    width: 40%;
    border-radius: 50%;
}
	
.label {
    color: black;
    width: 120px;
    height: 50px;
    padding: 6px;
    display: block;
    float:left;
    vertical-align: middle;
}
	
.loginelement {
    width: 130px;
    height: 50px;
    vertical-align: middle;
    line-height: 50px;
    float: left;
}

.container {
    padding: 16px;
}

span.psw {
    float: right;
    padding-top: 16px;
}

/* Change styles for span and cancel button on extra small screens */
@media screen and (max-width: 300px) {
    span.psw {
       display: block;
       float: none;
    }
    .cancelbtn {
       width: 100%;
    }
}
</style>
<body>
  
  <div id="myloader" style="display:none;">
    	<h2>Loading your page...</h2>
    	<div class="loader"></div>
  </div>
    




  <div id="mylogin" style="display:none;">
    
    <h2>Report Login</h2>
        <div class="loginelement"><b>Account Number</b></div>
	<input id="accnumb" type="text" placeholder="Enter Account Number">
	</br>
	
	<div class="loginelement"><b>Username</b></div>
        <input id="uname" type="text" placeholder="Enter Username">
	</br>
        
	<div class="loginelement"><b>Password</b></div>
        <input id="pwd" type="password" placeholder="Enter Password">
	</br>
        
    <button id="submitLogin" >Login</button>
    
    </br></br></br></br>

  <div id="sendStat"></div>

</div>


<div id="myreports" style="display:none;">
  
    <h2>Download your transcripts:</h2>
    <label><b>Start date</b></label></br>

    <input id="startdate" type="date" />
    <input id="starthour" type="time">
    </br>

    <label><b>End date</b></label></br>

    <input id="enddate" type="date" />
    <input id="endhour" type="time">
    
    </br></br>
    <label><b>Options: </b></label>
    <select id="transcriptOptions">
        <option>Open</option>
        <option>Close</option>
        <option>Active</option>
    </select>
    </br></br>
    <button type="button" id ="downloadTranscripts" class="downloadTranscripts">Download</button></br></br>
    <div id="reportMSG"></div>
    <a id="hiddenbutton" style="visibility:hidden;" href="">Hidden</a>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script>
  
  var uri = "";
  var uname;
  var pwd;
  var csrf;
  var accnumb = localStorage.getItem('account_number');
  var bearer = localStorage.getItem('bearer');
  
  function checklogin(accnumb, bearer){	
	$('#myloader').css('display', 'inline');
  	if(!((accnumb === null) || (accnumb === '') || (bearer === null) || (bearer === ''))){
    		$.ajax({
                    url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/msgHist/baseURI.lpCsds?version=1.0",
                    jsonp: "cb",
                    jsonpCallback: "domainCallback",
                    cache: true,
                    dataType: "jsonp",
                    success: function success(data) {
                        if('lpCallError' in data.ResultSet){
				localStorage.setItem('account_number', '');
			   	return false;
                        }
                        else{
                           	uri = data.ResultSet.lpData[0].lpServer;
                           	console.log(uri);

                           	$.ajax({
                              		url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=0&limit=50",
                              		method: "POST",
                              		jsonp: "cb",
                              		jsonpCallback: "domainCallback",
                              		cache: true,
                              		contentType: "application/json",
                              		data: '{\"start":{\"from\":' + (new Date().getTime()-5000) + ',\"to\":'+ new Date().getTime() + '}}',
                              		success: function success(data) {
						refreshTranscripts();
						$('#myloader').css('display', 'none');
          					$('#myreports').css('display', 'inline');
						return true;
                              		},
                              		error: function error(e, text) {
						localStorage.setItem('account_number', '');
				    		return false;
                              		},
                              		beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); } 
                          	});   
                        }
                    },
                    error: function error(e, text) {
			    console.log(text);
			    localStorage.setItem('account_number', '');
			    return false;
                    }
              	});
  	  }
	  else{
		  localStorage.setItem('account_number', '');
		  return false;
	  }
  }
	
	
  if(!((accnumb === null) || (accnumb === '') || (bearer === null) || (bearer === ''))){
	  if (!checklogin(accnumb, bearer)){
		  location.reload();
	  }
  }
  else{
	  $('#myloader').css('display', 'none');
          $('#mylogin').css('display', 'inline');
  }
	  
	
	
	
	
	
  
  $(document).on('click', function(evt) {
	  if($("#accnumb").val() != ""){
		  if($(evt.target).is('#submitLogin')) {
			  uname = $("#uname").val();
			  pwd = $("#pwd").val();
			  accnumb = $("#accnumb").val();
			  console.log(accnumb + " *** " + uname + " *** " + pwd);
			  $.ajax({
				  url: "https://adminlogin.liveperson.net/csdr/account/" + accnumb + "/service/agentVep/baseURI.lpCsds?version=1.0",
				  jsonp: "cb",
				  jsonpCallback: "domainCallback",
				  cache: true,
				  dataType: "jsonp",
				  success: function success(data) {
					  if('lpCallError' in data.ResultSet){
						  document.getElementById("sendStat").innerHTML = "Please insert a correct login!";
						  document.getElementById("sendStat").style = "color : red";
					  }
					  else{
						  uri = data.ResultSet.lpData[0].lpServer;
						  console.log(uri);
						  $.ajax({
							  url: "https://" + uri + "/api/account/" + accnumb + "/login?v=1.3",
							  method: "POST",
							  jsonp: "cb",
							  jsonpCallback: "domainCallback",
							  cache: true,
							  contentType: "application/json",
							  data: '{"username":"' + uname + '","password":"' + pwd +'"}',
							  success: function success(data) {
								  console.log("******" + JSON.stringify(data) + "******");
								  csrf = data.csrf;
								  bearer = data.bearer;
								  localStorage.setItem('account_number', accnumb);
								  localStorage.setItem('csrf', csrf);
								  localStorage.setItem('bearer', bearer);
								  $('#mylogin').css('display', 'none');
								  $('#myloader').css('display', 'inline');
								  setTimeout(function(){
									  $('#myloader').css('display', 'none');
									  $('#myreports').css('display', 'inline');
									  refreshTranscripts();
								  }, 2000);
							  },
							  error: function error(e, text) {
								  document.getElementById("sendStat").innerHTML = "Please insert a correct login!";
								  document.getElementById("sendStat").style = "color : red";
							  }
						  });
						  return data;
					  }
				  },
				  error: function error(e, text) {
					  console.log(text);
					  return e;
				  }
			  });
		  }
	  }
  });
    

  function refreshTranscripts(){
	  
	 var date = new Date();
	 var dd = date.getDate();
    	 var mm = date.getMonth() + 1;
    	 var y = date.getFullYear();
	 var enddate = y + "-" + mm + "-" + dd;
	 
	 date.setDate(date.getDate() - 7);
	 var dd = date.getDate();
    	 var mm = date.getMonth() + 1;
    	 var y = date.getFullYear();
	 var startdate = y + "-" + mm + "-" + dd;

	 
	 $('#startdate').val(startdate);
	 $('#starthour').val("00:00");
	 $('#enddate').val(enddate);
	 $('#endhour').val("23:59");
	  
	  
	 $(document).on('click', function(evt) {
		 
              if($(evt.target).is('.downloadTranscripts')) {
		     
		    startdate = $('#startdate').val();
		    startdate = new Date(startdate);
		    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		    var year = startdate.getFullYear();
  		    var month = months[startdate.getMonth()];
  	            var date = startdate.getDate(); 
		    var hour = $('#starthour').val();
		    startdate = month + " " + date + " " + year + " " + hour + ":00 GMT+0100 (CET)"
		    var d = new Date(startdate);
		    var start = d.getTime();
		      
		    
		    enddate = $('#enddate').val();
		    enddate = new Date(enddate);
		    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
		    var year = enddate.getFullYear();
  		    var month = months[enddate.getMonth()];
  	            var date = enddate.getDate(); 
		    var hour = $('#endhour').val();
		    enddate = month + " " + date + " " + year + " " + hour + ":00 GMT+0100 (CET)"
		    var d = new Date(enddate);
		    var end = d.getTime();  

		    var options = $('#transcriptOptions').val();
		      
		    if (start >= end) { 
			    document.getElementById("reportMSG").innerHTML = "Please insert a correct end date!";
                            document.getElementById("reportMSG").style = "color : red"; 
		    }
		    else if (((end - start)/1000) > (60*60*24*31)){
			    document.getElementById("reportMSG").innerHTML = "No more than 30 days!";
                            document.getElementById("reportMSG").style = "color : red"; 
		    }
		    else{
			    document.getElementById("reportMSG").innerHTML = "";
			    downloadTranscripts(start, end, options);
		    }
		      
		      
		    
              }
	 });

	  
	  
  }
    
   
 function downloadTranscripts(start, end, options){
	 
	 var body = "";
	 
	 if (options === "Open"){ 
		 body = '{"start":{"from":' + start + ',"to":' + end + '},"status":["OPEN"]}'; 
	 }
	 else if (options === "Close"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '},"status":["CLOSE"]}';	 
	 }
	 else if (options === "Active"){
		 body = '{"start":{"from":' + start + ',"to":' + end + '}, "messageContentTypes": ["TEXT_PLAIN"]}';	 
	 }
	 
	 $.ajax({
                              url: "https://" + uri + "/messaging_history/api/account/" + accnumb + "/conversations/search?offset=0&limit=100",
                              method: "POST",
                              jsonp: "cb",
                              jsonpCallback: "domainCallback",
                              cache: true,
                              contentType: "application/json",
                              data: body,
                              success: function success(data) {

                                console.log(data);
                              
                                                   
                                
                              },
                              error: function error(e, text) {
                                    
                              },
                              beforeSend: function(xhr, settings) { xhr.setRequestHeader('Authorization','Bearer ' + bearer); } 
                          });
	 
	 
	 
	 
	 
	 
	 
	 
testJson = [
    {
        "start": "Tony Peña",
        "end": "New York",
        "agent": "United States",
        "conversation": "1978-03-15",
        "transcript": "42"

    },
    {
        "start": "Ζαλώνης Thessaloniki",
        "end": "Athens",
        "agent": "Greece",
        "conversation": "1987-11-23",
        "transcript": "42"
    }
];

// Simple type mapping; dates can be hard
// and I would prefer to simply use `datevalue`
// ... you could even add the formula in here.
	 
testTypes = {
    "start": "String",
    "end": "String",
    "agent": "String",
    "conversation": "String",
    "transcript": "String"
};

emitXmlHeader = function () {
    var headerRow =  '<ss:Row>\n';
    for (var colName in testTypes) {
        headerRow += '  <ss:Cell>\n';
        headerRow += '    <ss:Data ss:Type="String">';
        headerRow += colName + '</ss:Data>\n';
        headerRow += '  </ss:Cell>\n';        
    }
    headerRow += '</ss:Row>\n';    
    return '<?xml version="1.0"?>\n' +
           '<ss:Workbook xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n' +
           '<ss:Worksheet ss:Name="Sheet1">\n' +
           '<ss:Table>\n\n' + headerRow;
};

emitXmlFooter = function() {
    return '\n</ss:Table>\n' +
           '</ss:Worksheet>\n' +
           '</ss:Workbook>\n';
};

jsonToSsXml = function (jsonObject) {
    var row;
    var col;
    var xml;
    var data = typeof jsonObject != "object" ? JSON.parse(jsonObject) : jsonObject;
    
    xml = emitXmlHeader();

    for (row = 0; row < data.length; row++) {
        xml += '<ss:Row>\n';
      
        for (col in data[row]) {
            xml += '  <ss:Cell>\n';
            xml += '    <ss:Data ss:Type="' + testTypes[col]  + '">';
            xml += data[row][col] + '</ss:Data>\n';
            xml += '  </ss:Cell>\n';
        }

        xml += '</ss:Row>\n';
    }
    
    xml += emitXmlFooter();
    return xml;  
};

console.log(jsonToSsXml(testJson));

download = function (content, filename, contentType) {
    if (!contentType) contentType = 'application/octet-stream';
    var a = document.getElementById('hiddenbutton');
    var blob = new Blob([content], {
        'type': contentType
    });
    a.href = window.URL.createObjectURL(blob);
    a.download = filename;
};

download(jsonToSsXml(testJson), 'transcripts.xls', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
$("#hiddenbutton")[0].click();	 
	 
	 
	 
	 
	 
	 console.log(start + "****" + end + "****" + options);
	 
 }
   
    
</script>
    
    


</body>
</html>
